<UserControl x:Class="ForRobot.Views.Controls.NavigationTreeView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:ForRobot.Views.Controls"
             xmlns:model="clr-namespace:ForRobot.Model.Controls"
             xmlns:vm="clr-namespace:ForRobot.ViewModels"
             xmlns:conv="clr-namespace:ForRobot.Libr.Converters"
             mc:Ignorable="d">

    <UserControl.DataContext>
        <vm:NavigationTreeViewModel/>
    </UserControl.DataContext>

    <UserControl.Resources>
        <!--Colors-->
        <Color x:Key="DarkGrayColor">#FF707070</Color>
        <Color x:Key="BlackColor">#FF000000</Color>
        <Color x:Key="LightBlue">#b5eaff</Color>
        <Color x:Key="LightMediumBlue">#85caff</Color>
        <Color x:Key="Yellow">#FFBF1C</Color>

        <!--SolidColorBrushs-->
        <SolidColorBrush x:Key="WhiteBrush" Color="White"/>
        <SolidColorBrush x:Key="NotActiveBorderBrush" Color="{DynamicResource DarkGrayColor}"/>
        <SolidColorBrush x:Key="ActiveBackround" Color="{DynamicResource LightBlue}"/>
        <SolidColorBrush x:Key="IsSelectedBackround" Color="{DynamicResource LightMediumBlue}"/>

        <SolidColorBrush x:Key="FolderIconStroke" Color="{DynamicResource Yellow}"/>
        <SolidColorBrush x:Key="FolderIconFill" Color="{DynamicResource Yellow}"/>

        <SolidColorBrush x:Key="IconStrokeBrush" Color="{DynamicResource BlackColor}"/>
        <SolidColorBrush x:Key="IconFillBrush" Color="{DynamicResource BlackColor}"/>

        <!--Geometry-->
        <Geometry x:Key="UnknowIcon">M12.57,17.29a1,1,0,0,0-1.41,0,1.06,1.06,0,0,0-.22.33,1.07,1.07,0,0,0,0,.76,1.19,1.19,0,0,0,.22.33,1,1,0,0,0,.32.21,1,1,0,0,0,.39.08,1,1,0,0,0,.92-1.38A.91.91,0,0,0,12.57,17.29ZM20,8.94a1.31,1.31,0,0,0-.06-.27l0-.09a1.07,1.07,0,0,0-.19-.28h0l-6-6h0a1.07,1.07,0,0,0-.28-.19l-.09,0A.88.88,0,0,0,13.05,2H7A3,3,0,0,0,4,5V19a3,3,0,0,0,3,3H17a3,3,0,0,0,3-3V9S20,9,20,8.94ZM14,5.41,16.59,8H15a1,1,0,0,1-1-1ZM18,19a1,1,0,0,1-1,1H7a1,1,0,0,1-1-1V5A1,1,0,0,1,7,4h5V7a3,3,0,0,0,3,3h3Zm-6.13-9a3,3,0,0,0-2.6,1.5,1,1,0,1,0,1.73,1,1,1,0,0,1,.87-.5,1,1,0,0,1,0,2,1,1,0,1,0,0,2,3,3,0,0,0,0-6Z</Geometry>
        <Geometry x:Key="OpenFolderIcon">M2 14c-0.36818666666666666 0 -0.6666666666666666 -0.29846666666666666 -0.6666666666666666 -0.6666666666666666V2.6666666666666665c0 -0.36818666666666666 0.29847999999999997 -0.6666666666666666 0.6666666666666666 -0.6666666666666666h4.9428l1.3333333333333333 1.3333333333333333H13.333333333333332c0.36819999999999997 0 0.6666666666666666 0.29847999999999997 0.6666666666666666 0.6666666666666666v2H2.6666666666666665v6.664L4 7.333333333333333h11l-1.5404 6.161666666666666c-0.07419999999999999 0.29679999999999995 -0.34086666666666665 0.5049999999999999 -0.6467999999999999 0.5049999999999999H2Z</Geometry>
        <Geometry x:Key="FolderIcon">M25.5 27.599999999999998C27.8195 27.599874999999997 29.700000000000003 25.719500000000004 29.700000000000003 23.4V17.1C29.700000000000003 14.7805 27.8195 12.900125 25.5 12.9H4.5C2.1803749999999997 12.899875000000002 0.3 14.780375 0.3 17.1V23.4C0.3 25.719625 2.1803749999999997 27.600125000000002 4.5 27.599999999999998H25.5ZM0.3 12.404375000000002V6.6000000000000005C0.3 4.280375 2.1803749999999997 2.4 4.5 2.4H12.030624999999999C12.8655 2.400375 13.66625 2.73225 14.256625 3.3226250000000004L17.227375000000002 6.292C17.423375 6.489374999999999 17.69075 6.6000000000000005 17.969375 6.6000000000000005H25.5C27.819625000000002 6.6000000000000005 29.700000000000003 8.480375 29.700000000000003 10.8V12.404375000000002C28.546125 11.36925 27.050125 10.797749999999999 25.5 10.8H4.5C2.949875 10.797749999999999 1.453875 11.36925 0.3 12.404375000000002Z</Geometry>
        <Geometry x:Key="DataListIcon">M26.204116796875 8.261261718750001 18.552580078124997 0.609725c-0.20516367187499998 -0.20493710937499998 -0.48335976562499994 -0.31995156249999995 -0.7733484375 -0.319725H4.662305078125c-1.20741953125 -0.000056640625 -2.186146875 0.9787386718750001 -2.186146875 2.186158203125v24.047683593749998c0 1.20741953125 0.9787273437499999 2.1862148437499997 2.186146875 2.186158203125h19.67538984375c1.20741953125 0.000056640625 2.186146875 -0.9787386718750001 2.186146875 -2.186158203125V9.034621484375c0.0002265625 -0.29 -0.11478789062500001 -0.568184765625 -0.319725 -0.773359765625Zm-7.33181171875 12.7972015625H10.127694921875c-0.841453125 -0.0000453125 -1.3673726562500002 -0.9109625000000001 -0.946612109375 -1.63965546875 0.195262890625 -0.338178515625 0.556108984375 -0.546502734375 0.946612109375 -0.546502734375h8.74461015625c0.841453125 0 1.3673613281249999 0.9108945312500001 0.946634765625 1.639621484375 -0.1952515625 0.338178515625 -0.556131640625 0.5465140625 -0.946634765625 0.54653671875Zm0 -4.372305078125H10.127694921875c-0.841453125 -0.0000453125 -1.3673726562500002 -0.9109625000000001 -0.946612109375 -1.6396667968749998C9.376345703125 14.70832421875 9.737191796875 14.5 10.127694921875 14.5h8.74461015625c0.841453125 0 1.3673613281249999 0.9108945312500001 0.946634765625 1.63961015625 -0.1952515625 0.33818984375 -0.556131640625 0.5465253906249999 -0.946634765625 0.546548046875Zm-1.0930734375 -7.65153671875V3.022694921875l6.0119265625 6.0119265625Z</Geometry>
        <Geometry x:Key="ProgramIcon">M26.523841796875 2.476158203125H2.476158203125C1.268738671875 2.4761015625000002 0.29 3.454885546875 0.29 4.662305078125v19.67538984375c0 1.207408203125 0.9787386718750001 2.186203515625 2.186158203125 2.186146875h24.047683593749998c1.207340234375 -0.0000453125 2.186158203125 -0.9788066406249999 2.186158203125 -2.186146875V4.662305078125c0 -1.20737421875 -0.97877265625 -2.186146875 -2.186158203125 -2.186146875Zm-12.43375 12.877812500000001 -5.465378515625 4.372305078125c-0.657382421875 0.525908203125 -1.637559765625 0.1429609375 -1.764321484375 -0.689305078125 -0.058826953125 -0.386255078125 0.09287929687499999 -0.7745605468750001 0.397968359375 -1.0186250000000001L11.656629296875 14.5 7.258360156250001 10.981654296875c-0.657382421875 -0.525908203125 -0.4989359375 -1.566237890625 0.285208203125 -1.872595703125 0.363916015625 -0.142179296875 0.776055859375 -0.07941015624999999 1.081144921875 0.164665625l5.465378515625 4.372305078125c0.547680859375 0.43759414062499996 0.547680859375 1.270347265625 0 1.70794140625Zm6.968371484375 4.611419140625h-5.465389843750001c-0.841441796875 -0.0000453125 -1.3673613281249999 -0.9109625000000001 -0.9466007812499999 -1.6396667968749998 0.195262890625 -0.33816718749999997 0.556108984375 -0.54649140625 0.9466007812499999 -0.54649140625h5.465389843750001c0.841453125 0 1.3673613281249999 0.9108945312500001 0.946634765625 1.63961015625 -0.1952515625 0.33818984375 -0.556131640625 0.5465253906249999 -0.946634765625 0.546548046875Z</Geometry>
        <Geometry x:Key="HomeIcon">M 9, 20 V 14 H 13 V 20 H 19 V 12 H 22 L 11, 2 L 0,12 H 3 V 20 Z</Geometry>
        <Geometry x:Key="UpdateIcon">M 10,3 H 4 L 6,5 A 12,12 180 1,0 17,3 C 17,3 16,3 16,6 A 9,9 180 1,1 8.5,7 L 11,9 V 3 Z</Geometry>
        <Geometry x:Key="SendIcon">M 0 0 V 1 H 8 v-1 h-8 Z M 4 2l-3 3 h 2 v 3 h 2 v-3 h 2l-3-3 Z</Geometry>
        <Geometry x:Key="DeleteIcon">M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M9,8H11V17H9V8M13,8H15V17H13V8Z</Geometry>

        <Geometry x:Key="NormalArrow">M0,0 L4,3.5 0,7 z</Geometry>
        <Geometry x:Key="ExpandedArrow">M0,3 L7,3 3.5,7 z</Geometry>

        <!--<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="#000000" aria-hidden="true" id="Folder-Streamline-Heroicons" height="40" width="40">
            <desc>
                Folder Streamline Icon: https://streamlinehq.com
            </desc>
            <path d="M32.5 35a5 5 0 0 0 5 -5v-7.5a5 5 0 0 0 -5 -5h-25a5 5 0 0 0 -5 5V30a5 5 0 0 0 5 5h25Zm-30 -18.09V10a5 5 0 0 1 5 -5h8.965a3.75 3.75 0 0 1 2.6500000000000004 1.0983333333333334l3.5366666666666666 3.535c0.23333333333333336 0.235 0.5516666666666667 0.3666666666666667 0.8833333333333334 0.3666666666666667H32.5a5 5 0 0 1 5 5v1.91A7.471666666666667 7.471666666666667 0 0 0 32.5 15h-25a7.471666666666667 7.471666666666667 0 0 0 -5 1.91Z" stroke-width="1.6667"></path>
        </svg>-->

        <!--Styles-->
        <Style x:Key="ButtonBase" TargetType="{x:Type Button}">
            <Setter Property="Width" Value="{Binding Path=ActualHeight, RelativeSource={RelativeSource Self}}"/>
            <Setter Property="Template" Value="{DynamicResource ButtonTemplate}"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <Style TargetType="{x:Type Button}" BasedOn="{StaticResource ButtonBase}"/>

        <Style x:Key="PathBase" TargetType="{x:Type Path}">
            <Setter Property="Stretch" Value="Uniform"/>
            <Setter Property="Fill" Value="{StaticResource IconFillBrush}"/>
        </Style>

        <Style TargetType="{x:Type Path}" BasedOn="{StaticResource PathBase}"/>

        <!--Template-->
        <ControlTemplate x:Key="ButtonTemplate" TargetType="{x:Type Button}">
            <Border Name="Panel" BorderThickness="{TemplateBinding BorderThickness}"
                    BorderBrush="{TemplateBinding BorderBrush}" Background="{TemplateBinding Background}">

                <ContentPresenter x:Name="Content"
                                  VerticalAlignment="Center" HorizontalAlignment="Center"
                                  ContentSource="Content" Margin="8"/>
            </Border>

            <ControlTemplate.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter TargetName="Panel" Property="Background" Value="{DynamicResource ActiveBackround}"/>
                    <Setter TargetName="Panel" Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                </Trigger>

                <Trigger Property="IsPressed" Value="True">
                    <Setter TargetName="Panel" Property="Background" Value="{DynamicResource IsSelectedBackround}"/>
                    <Setter TargetName="Panel" Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <ControlTemplate x:Key="ToggleButtonTemplate" TargetType="{x:Type ToggleButton}">
            <Border Name="Panel" BorderThickness="{TemplateBinding BorderThickness}"
                    BorderBrush="{TemplateBinding BorderBrush}" Background="{TemplateBinding Background}">

                <ContentPresenter x:Name="Content"
                                  VerticalAlignment="Center" HorizontalAlignment="Center"
                                  ContentSource="Content" Margin="5"/>
            </Border>

            <ControlTemplate.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter TargetName="Panel" Property="Background" Value="{DynamicResource ActiveBackround}"/>
                    <Setter TargetName="Panel" Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                </Trigger>

                <Trigger Property="IsPressed" Value="True">
                    <Setter TargetName="Panel" Property="Background" Value="{DynamicResource IsSelectedBackround}"/>
                    <Setter TargetName="Panel" Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                </Trigger>

                <Trigger Property="IsChecked"  Value="True">
                    <Setter TargetName="Panel" Property="Background" Value="{DynamicResource IsSelectedBackround}"/>
                    <Setter TargetName="Panel" Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate> 

        <ControlTemplate x:Key="ListBoxItemTemplate" TargetType="{x:Type ListBoxItem}">
            <Border BorderThickness="0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <ContentPresenter Grid.Column="0" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="10, 0"
                                      Content="{Binding Path=Content, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}"/>

                    <ToggleButton Grid.Column="1" x:Name="toggleButtonMenu"
                                  IsChecked="{Binding Path=IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem, Mode=FindAncestor}, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}">

                        <ToggleButton.Template>
                            <ControlTemplate TargetType="{x:Type ToggleButton}">
                                <Border Background="Transparent" BorderThickness="0.5" Padding="10, 5">
                                    <Path Fill="#FF000000" HorizontalAlignment="Center" VerticalAlignment="Center" IsHitTestVisible="True">

                                        <Path.Style>
                                            <Style TargetType="{x:Type Path}">
                                                <Setter Property="Data" Value="{StaticResource NormalArrow}"/>

                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Path=IsChecked, RelativeSource={RelativeSource AncestorType={x:Type ToggleButton}, Mode=FindAncestor}}" Value="True">
                                                        <Setter Property="Data" Value="{StaticResource ExpandedArrow}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Path.Style>
                                    </Path>

                                    <Border.Style>
                                        <Style TargetType="{x:Type Border}">
                                            <Setter Property="BorderBrush" Value="Transparent"/>

                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Path=IsSelected, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}"  Value="True">
                                                    <Setter Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding Path=IsPressed, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}"  Value="True">
                                                    <Setter Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding Path=IsMouseOver, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}" Value="True">
                                                    <Setter Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                </Border>
                            </ControlTemplate>
                        </ToggleButton.Template>
                    </ToggleButton>

                    <Popup IsOpen="{Binding Path=IsChecked, ElementName=toggleButtonMenu}" StaysOpen="False" Placement="Bottom"
                           PlacementTarget="{Binding ElementName=toggleButtonMenu}" AllowsTransparency="True"
                           PopupAnimation="{DynamicResource {x:Static SystemParameters.ComboBoxPopupAnimationKey}}">

                        <Border BorderBrush="Black" BorderThickness="1">
                            <ListBox SelectionMode="Single" Margin="{Binding Padding}"
                                     ItemsSource="{Binding Path=ChildrenFolder, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                     SelectedItem="{Binding Path=SelectedPopupItem, Mode=OneWayToSource, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                     SelectedValuePath="Path">

                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <!--<Image Grid.Column="0" Source="{Binding Icon}" Stretch="Fill" Height="25"/>-->
                                            <Label Grid.Column="1" Content="{Binding Name}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <!--<Border.Style>
                                <Style TargetType="{x:Type Border}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Path=CanOpenMenu, RelativeSource={RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}}"
                                                     Value="False">
                                            <Setter Property="Visibility" Value="Hidden"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>-->
                        </Border>

                        <Popup.Style>
                            <Style TargetType="{x:Type Popup}">
                                <Style.Triggers>
                                    <!--<DataTrigger Binding="{Binding Path=CanOpenMenu, RelativeSource={RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}}" Value="{StaticResource True}">
                                        <Setter Property="IsOpen" Value="{Binding Path=IsChecked, ElementName=toggleButtonMenu}"/>
                                    </DataTrigger>

                                    <DataTrigger Binding="{Binding Path=CanOpenMenu, RelativeSource={RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}}" Value="{StaticResource False}">
                                        <Setter Property="IsOpen" Value="False"/>
                                    </DataTrigger>-->

                                    <!--<DataTrigger Binding="{Binding Path=ChildrenFolder.Count, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}" Value="0">
                                        <Setter Property="IsOpen" Value="False"/>
                                        <Setter Property="Visibility"  Value="Hidden"/>
                                    </DataTrigger>-->
                                </Style.Triggers>
                            </Style>
                        </Popup.Style>
                    </Popup>
                </Grid>

                <Border.Style>
                    <Style TargetType="{x:Type Border}">
                        <Setter Property="Background" Value="Transparent"/>

                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Path=IsSelected, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}"  Value="True">
                                <Setter Property="Background" Value="{DynamicResource IsSelectedBackround}"/>
                            </DataTrigger>

                            <DataTrigger Binding="{Binding Path=IsPressed, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}"  Value="True">
                                <Setter Property="Background" Value="{DynamicResource ActiveBackround}"/>
                            </DataTrigger>

                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding Path=IsMouseOver, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}" Value="True"/>
                                    <Condition Binding="{Binding Path=IsSelected, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}}"  Value="False"/>
                                </MultiDataTrigger.Conditions>

                                <Setter Property="Background" Value="{DynamicResource ActiveBackround}"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <Border.InputBindings>
                    <MouseBinding MouseAction="LeftClick" Command="{Binding Path=SelectDirectoryCommand, RelativeSource={RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}}">
                        <MouseBinding.CommandParameter>
                            <MultiBinding Converter="{StaticResource ArrayMultiValueConvert}">
                                <Binding Path="ItemsSource" RelativeSource="{RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}"/>
                                <Binding Path="Content" RelativeSource="{RelativeSource AncestorType={x:Type ListBoxItem}, Mode=FindAncestor}"/>
                                <Binding Path="." RelativeSource="{RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}"/>
                            </MultiBinding>
                        </MouseBinding.CommandParameter>
                    </MouseBinding>
                </Border.InputBindings>
            </Border>
        </ControlTemplate>

        <HierarchicalDataTemplate x:Key="NavTreeItemTemplate"
                                  ItemsSource="{Binding Path=Children, Mode=OneWay, NotifyOnSourceUpdated=True}"
                                  DataType="{x:Type model:File}">

            <HeaderedContentControl>
                <HeaderedContentControl.Template>
                    <ControlTemplate TargetType="{x:Type HeaderedContentControl}">
                        <Button ToolTip="{Binding Path=Path, Mode=OneTime}"
                                Background="Transparent" BorderBrush="Transparent"
                                Focusable="False" ClickMode="Press"
                                Tag="{Binding RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}}}">

                            <Grid Margin="0, 5" VerticalAlignment="Stretch">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Viewbox Grid.Column="0" Height="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType={x:Type Grid}, Mode=FindAncestor}}"
                                             HorizontalAlignment="Left" VerticalAlignment="Center" Margin="6,0,0,0">
                                    <CheckBox IsChecked="{Binding Path=IsCheck, Mode=TwoWay}" Margin="0, 5"/>
                                </Viewbox>

                                <Path Grid.Column="1" Margin="5, 0" Stretch="Uniform">
                                    <Path.Style>
                                        <Style TargetType="{x:Type Path}">
                                            <Setter Property="Stretch" Value="Uniform"/>

                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Path=Type}" Value="{x:Static model:FileTypes.Unknow}">
                                                    <Setter Property="RenderTransformOrigin" Value="0.5, 0.5"/>
                                                    <Setter Property="LayoutTransform">
                                                        <Setter.Value>
                                                            <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter Property="Stretch" Value="Fill"/>
                                                    <Setter Property="Fill" Value="Black"/>
                                                    <Setter Property="Data" Value="{StaticResource UnknowIcon}"/>
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding Path=Type}" Value="{x:Static model:FileTypes.Folder}">
                                                    <Setter Property="Fill" Value="{StaticResource FolderIconFill}"/>
                                                    <Setter Property="Data" Value="{StaticResource FolderIcon}"/>
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding Path=Type}" Value="{x:Static model:FileTypes.DataList}">
                                                    <Setter Property="Fill" Value="Black"/>
                                                    <Setter Property="Data" Value="{StaticResource DataListIcon}"/>
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding Path=Type}" Value="{x:Static model:FileTypes.Program}">
                                                    <Setter Property="Fill" Value="Black"/>
                                                    <Setter Property="Data" Value="{StaticResource ProgramIcon}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Path.Style>
                                </Path>

                                <TextBlock Grid.Column="2" Margin="5, 0" Text="{Binding Name, Mode=OneTime}"
                                               TextAlignment="Left" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="{x:Type TextBlock}">
                                            <Setter Property="Foreground" Value="Black"/>

                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Path=IsCopy}" Value="True">
                                                    <Setter Property="Foreground" Value="#FF0C2595"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>

                            <Button.Style>
                                <Style TargetType="{x:Type Button}">
                                    <Setter Property="Command" Value="{Binding Path=SelectFileCommandAsync, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:NavigationTreeView}}}"/>
                                    <Setter Property="CommandParameter" Value="{Binding Path=Path}"/>
                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu>
                                                <MenuItem Header="Удалить"
                                                          Command="{Binding Path=PlacementTarget.Tag.DeleteFileCommandAsync, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ContextMenu}}}"
                                                          CommandParameter="{Binding Path=Path}"/>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Path=Type}" Value="{x:Static model:FileTypes.Folder}">
                                            <Setter Property="Command" Value="{x:Null}"/>
                                            <Setter Property="ContextMenu">
                                                <Setter.Value>
                                                    <ContextMenu>
                                                        <MenuItem Header="Выбрать" Command="{Binding Path=PlacementTarget.Tag.SelectControllerFolderCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ContextMenu}}}"
                                                                  CommandParameter="{Binding Path=Path}"/>
                                                        <MenuItem Header="Удалить" Command="{Binding Path=PlacementTarget.Tag.DeleteFileCommandAsync, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ContextMenu}}}"
                                                                  CommandParameter="{Binding Path=Path}"/>
                                                    </ContextMenu>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </ControlTemplate>
                </HeaderedContentControl.Template>
            </HeaderedContentControl>
        </HierarchicalDataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <ComboBox Grid.Row="0" Focusable="False"
                  FontSize="{Binding Path=FontSize, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}" 
                  BorderBrush="{Binding Path=BorderBrush, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}" BorderThickness="1"
                  Background="{Binding Path=Background, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                  HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch">

            <ComboBox.Resources>
                <Style TargetType="{x:Type Path}" BasedOn="{StaticResource PathBase}"/>
            </ComboBox.Resources>
            
            <ComboBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel IsItemsHost="True" />
                </ItemsPanelTemplate>
            </ComboBox.ItemsPanel>

            <ComboBox.Template>
                <ControlTemplate TargetType="{x:Type ComboBox}">
                    <Border BorderThickness="{TemplateBinding BorderThickness}" BorderBrush="{TemplateBinding BorderBrush}" Background="{TemplateBinding Background}">
                        <Grid IsEnabled="{Binding Path=Robot.IsConnection, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" ToolTip="Возврат к начальной папке"
                                    Command="{Binding Path=HomeCommand}"
                                    CommandParameter="{Binding Path=RobotSource, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}">

                                <Path Data="{StaticResource HomeIcon}">
                                    <Path.LayoutTransform>
                                        <ScaleTransform ScaleX="1.2" ScaleY="1.2"/>
                                    </Path.LayoutTransform>
                                </Path>
                            </Button>

                            <Border Grid.Column="1" BorderThickness="0"
                                    Background="{TemplateBinding Background}"
                                    Height="{Binding Path=ActualHeight, RelativeSource={RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}}"
                                    HorizontalAlignment="Stretch" VerticalAlignment="Stretch">

                                <Border.Style>
                                    <Style TargetType="{x:Type Border}">
                                        <Setter Property="BorderBrush" Value="{DynamicResource NotActiveBorderBrush}"/>

                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Path=IsChecked, ElementName=togglePath}" Value="True">
                                                <Setter Property="BorderBrush" Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>

                                <Grid>
                                    <Grid.Style>
                                        <Style TargetType="{x:Type Grid}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Path=Visibility, ElementName=progressBar}" Value="Visible">
                                                    <Setter Property="IsEnabled" Value="False"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Grid.Style>

                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <ProgressBar x:Name="progressBar" Grid.ColumnSpan="2" Panel.ZIndex="1" Background="Transparent" BorderThickness="0"
                                                 Foreground="{DynamicResource {x:Static SystemColors.HotTrackBrushKey}}"
                                                 Minimum="0" Maximum="100" IsIndeterminate="True" 
                                                 Value="{Binding ElementName=BreadcrumbControl, Path=Progress}">

                                        <ProgressBar.Style>
                                            <Style TargetType="{x:Type ProgressBar}">
                                                <Setter Property="Visibility" Value="Hidden"/>

                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Path=Robot.IsLoadFiles, RelativeSource={RelativeSource AncestorType={x:Type local:Breadcrumb}, Mode=FindAncestor}}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ProgressBar.Style>
                                    </ProgressBar>

                                    <ToggleButton x:Name="togglePath" Grid.Column="0" IsChecked="False" BorderThickness="0"
                                                  Width="{Binding Path=ActualHeight, RelativeSource={RelativeSource Self}}"
                                                  Template="{StaticResource ToggleButtonTemplate}">

                                        <Path Fill="{StaticResource FolderIconStroke}" Stretch="Uniform">
                                            <Path.Style>
                                                <Style TargetType="{x:Type Path}">
                                                    <Setter Property="Data" Value="{StaticResource FolderIcon}"/>
                                                    <Setter Property="LayoutTransform">
                                                        <Setter.Value>
                                                            <ScaleTransform ScaleX="0.8" ScaleY="0.8"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Path=IsChecked, RelativeSource={RelativeSource AncestorType={x:Type ToggleButton}, Mode=FindAncestor}}" Value="True">
                                                            <Setter Property="Data" Value="{StaticResource OpenFolderIcon}"/>
                                                            <Setter Property="LayoutTransform">
                                                                <Setter.Value>
                                                                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Path.Style>
                                        </Path>
                                    </ToggleButton>

                                    <ContentControl Grid.Column="1"
                                                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch"
                                                    FontFamily="{Binding Path=FontFamily, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                                    Foreground="{Binding Path=Foreground, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                                    FontSize="{Binding Path=FontSize, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                                    Background="{Binding Path=Backround, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                                    BorderBrush="{Binding Path=BorderBrush, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}">
                                        <ContentControl.Style>
                                            <Style TargetType="{x:Type ContentControl}">
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="{x:Type ContentControl}">
                                                            <ListBox SelectionMode="Single" Height="{TemplateBinding Height}"
                                                                     FontSize="{TemplateBinding FontSize}" Foreground="{TemplateBinding Foreground}"
                                                                     Background="{TemplateBinding Background}"
                                                                     BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="1"
                                                                     HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"
                                                                     HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                                                                     ScrollViewer.HorizontalScrollBarVisibility="Hidden" ScrollViewer.VerticalScrollBarVisibility="Hidden"
                                                                     ItemsSource="{Binding Path=FoldersCollection, Mode=OneWay, UpdateSourceTrigger=PropertyChanged,
                                                                                           RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                                                     SelectedItem="{Binding Path=SelectedFolder, Mode=OneWayToSource, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                                                     SelectedValuePath="Name">

                                                                <ListBox.ItemContainerStyle>
                                                                    <Style TargetType="{x:Type ListBoxItem}">
                                                                        <Setter Property="Template" Value="{StaticResource ListBoxItemTemplate}"/>
                                                                    </Style>
                                                                </ListBox.ItemContainerStyle>

                                                                <ListBox.ItemsPanel>
                                                                    <ItemsPanelTemplate>
                                                                        <StackPanel Orientation="Horizontal"/>
                                                                    </ItemsPanelTemplate>
                                                                </ListBox.ItemsPanel>
                                                            </ListBox>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>

                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Path=IsChecked, ElementName=togglePath}" Value="True">
                                                        <Setter Property="Grid.ColumnSpan" Value="3"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="{x:Type ContentControl}">
                                                                    <TextBox Text="{Binding Path=RobotSource.PathControllerFolder, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                                                                             Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}"
                                                                             Foreground="{TemplateBinding Foreground}" FontSize="{TemplateBinding FontSize}"
                                                                             VerticalContentAlignment="Center" HorizontalContentAlignment="Left"/>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ContentControl.Style>
                                    </ContentControl>
                                </Grid>
                            </Border>

                            <Button Grid.Column="2" ToolTip="Обновить дерево файлов"
                                    Command="{Binding Path=UpdateFilesCommandAsync}"
                                    CommandParameter="{Binding Path=RobotSource, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}">

                                <Path Data="{StaticResource UpdateIcon}"/>
                            </Button>

                            <Button Grid.Column="3" ToolTip="Скачать файлы"
                                    Command="{Binding Path=DownladeFilesCommandAsync}"
                                    CommandParameter="{Binding Path=RobotSource, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}">

                                <Path Data="{StaticResource SendIcon}" Stretch="UniformToFill">
                                    <Path.LayoutTransform>
                                        <RotateTransform Angle="180"/>
                                    </Path.LayoutTransform>
                                </Path>
                            </Button>

                            <Button Grid.Column="4" ToolTip="Передача файлов"                                    
                                    Command="{Binding Path=DropFilesCommandAsync}"
                                    CommandParameter="{Binding Path=RobotSource, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}">

                                <Path Data="{StaticResource SendIcon}" Stretch="UniformToFill"/>
                            </Button>

                            <Button Grid.Column="5" ToolTip="Удаление файла/ов"
                                    Command="{Binding Path=DeleteFilesCommandAsync}"
                                    CommandParameter="{Binding Path=RobotSource, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}">

                                <Path Data="{StaticResource DeleteIcon}" Stretch="Uniform">
                                    <Path.LayoutTransform>
                                        <ScaleTransform ScaleX="1.5" ScaleY="1.5"/>
                                    </Path.LayoutTransform>
                                </Path>
                            </Button>
                        </Grid>
                    </Border>
                </ControlTemplate>
            </ComboBox.Template>
        </ComboBox>


        <TreeView Grid.Row="1"
                  IsEnabled="{Binding Path=RobotSource.IsConnection, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                  FontSize="{Binding Path=FontSize, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}" 
                  BorderBrush="{Binding Path=BorderBrush, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}" BorderThickness="1"
                  VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                  Background="{Binding Path=Background, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                  Padding="{Binding Path=Padding, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"   
                  ScrollViewer.CanContentScroll="True" ScrollViewer.VerticalScrollBarVisibility="Auto"  ScrollViewer.HorizontalScrollBarVisibility="Auto"
                  ItemsSource="{Binding Path=RobotSource.Files.Children, Mode=OneWay, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}"
                  ItemTemplate="{StaticResource NavTreeItemTemplate}">

            <TreeView.ItemContainerStyle>
                <Style TargetType="{x:Type TreeViewItem}">
                    <Setter Property="Focusable" Value="False"/>
                    <Setter Property="IsExpanded" Value="{Binding Path=IsExpanded, Mode=TwoWay}"/>

                    <Style.Triggers>
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding Path=Type}" Value="{x:Static model:FileTypes.DataList}"/>
                                <Condition Binding="{Binding Path=AccessDataFile, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}" Value="False"/>
                            </MultiDataTrigger.Conditions>

                            <MultiDataTrigger.Setters>
                                <Setter Property="Visibility" Value="Hidden"/>
                                <Setter Property="Height" Value="0"/>
                            </MultiDataTrigger.Setters>
                        </MultiDataTrigger>

                        <DataTrigger Value="True">
                            <DataTrigger.Binding>
                                <MultiBinding Converter="{StaticResource SelectProgramConvert}">
                                    <Binding Path="Name"/>
                                    <Binding Path="RobotSource.RobotProgramName" RelativeSource="{RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}"/>
                                </MultiBinding>
                            </DataTrigger.Binding>

                            <Setter Property="TextBlock.FontWeight" Value="Bold"/>
                        </DataTrigger>

                        <DataTrigger Binding="{Binding Path=RobotSource.IsLoadFiles, RelativeSource={RelativeSource AncestorType={x:Type local:NavigationTreeView}, Mode=FindAncestor}}" Value="True">
                            <Setter Property="IsEnabled" Value="False"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </TreeView.ItemContainerStyle>
        </TreeView>
    </Grid>
</UserControl>
